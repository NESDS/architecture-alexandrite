# Архитектурное решение по трейсингу

## 1. Анализ системы: места, где заказ может "сломаться"

### Критические точки отказа:

**1. Shop API → RabbitMQ** — сообщение не попало в очередь (сеть, переполнение)

**2. RabbitMQ → MES API** — consumer не обработал, таймаут, ошибка десериализации

**3. MES API: расчет стоимости** — процесс завис, ошибка 3D обработки, OOM

**4. MES API → S3 Storage** — файл недоступен, поврежден, таймаут

**5. MES API → RabbitMQ** — результат расчета не отправлен

**6. RabbitMQ → CRM API** — consumer не обработал, очередь переполнена

**7. CRM/Shop API → PostgreSQL** — DB недоступна, deadlock, constraint violation

**8. B2B API Users → MES API** — таймаут, rate limit, недоступность

---

## 2. Список данных для трейсинга

**Идентификаторы:**
- `trace_id`, `span_id`, `parent_span_id` — связь операций
- `order_id` — бизнес-идентификатор
- `user_id` / `api_key` — инициатор операции

**Метаданные:**
- `service_name`, `operation_name` — где и что происходит
- `timestamp_start/end`, `duration_ms` — временные рамки
- `status` (success, error, timeout)

**Бизнес-контекст:**
- `order_status`, `order_type` (B2C/B2B)
- `3d_model_complexity`, `file_size_bytes`

**Технические детали:**
- `http_method`, `http_url`, `http_status_code`
- `queue_name`, `error_message`, `instance_id`

---

## 3. Мотивация

**Текущая проблема:** Компания теряет B2B контракты из-за невозможности отследить заказы. Команда тратит часы на поиск проблем вручную. Клиенты жалуются, но причину найти быстро нельзя.

**Что даст трейсинг:** 
- Визуализация пути заказа через все системы за секунды
- Мгновенная идентификация узких мест
- Проактивное обнаружение проблем до жалоб

### Технические метрики

**1. MTTR (время устранения проблемы)**
- Текущее: 4-8 часов → Целевое: 15-30 минут

**2. Процент заказов с задержкой**
- Текущее: неизвестно → Целевое: автоматический мониторинг, алерт при > 5%

**3. Error Rate по этапам**
- Текущее: видим только HTTP 500 → Целевое: детальный error rate для каждого этапа

### Бизнес-метрики

**4. Order Completion Rate**
- Текущее: не измеряем → Целевое: 99.5% заказов доходят до CLOSED
- Импакт: сохранение выручки и репутации

**5. B2B API SLA Compliance**
- Текущее: теряем контракты → Целевое: 95% заказов за < 5 минут
- Импакт: сохранение B2B контрактов

---

## 4. Предлагаемое решение

### 4.1 Выбор технологии: Jaeger + OpenTelemetry

**Почему Jaeger:**
- Open-source, CNCF graduated project
- Готовые библиотеки для Java Spring Boot и C# .NET
- Масштабируется горизонтально
- UI для визуализации traces

### 4.2 Архитектура и компоненты

**Компоненты для внедрения:**

**1. Jaeger Collector** — принимает spans от всех сервисов (Shop API, CRM API, MES API)

**2. Jaeger Query + UI** — веб-интерфейс для поиска traces (доступ через VPN)

**3. Cassandra Cluster (3 ноды)** — хранение spans, retention 7 дней

**4. OpenTelemetry SDK** — библиотеки для Shop API (Java), CRM API (Java), MES API (C#) для автоматического сбора HTTP, DB, RabbitMQ spans

**5. RabbitMQ трейсинг** — передача trace_id через message headers для сквозной трассировки

**Как будет работать:**
- Каждый API инструментируется через OpenTelemetry SDK
- Автоматический сбор spans для HTTP-запросов, DB-операций, RabbitMQ-сообщений
- Кастомные spans для бизнес-операций (расчет цены, смена статуса заказа)
- Все spans отправляются в Jaeger Collector
- Sampling: 10% в production (все ERROR и медленные — 100%), 100% в dev/release

**Интеграция с существующим мониторингом:**
- Jaeger как data source в Grafana
- Drill-down из Grafana алертов в Jaeger traces
- Prometheus exemplars с trace_id для связи метрик и traces

### 4.3 Обновленная диаграмма C4

**Новые компоненты (красным):**
- Jaeger Collector, Jaeger Query + UI, Cassandra Cluster

**Новые связи (красным):**
- Shop/CRM/MES API → Jaeger Collector
- Jaeger Collector → Cassandra
- Jaeger Query → Cassandra

**Схема:** См. файл `Task3/Схема с трейсингом и автоматизацией.drawio` (компоненты трейсинга выделены красным)

---

## 5. Компромиссы

**1. Легаси MES код**
- Проблема: MES куплен с кодом, команда не знает его глубоко
- Компромисс: Auto-instrumentation (HTTP, DB) без глубокого внедрения. Детали — позже

**2. Внешние системы**
- Проблема: Будущие внешние API (платежи, доставка) не будут отправлять spans
- Компромисс: Traces обрываются на границе, создаем синтетические spans "external_call"

**3. Высокая нагрузка (> 10K RPS)**
- Проблема: При росте нагрузки даже 10% sampling перегрузит Cassandra
- Компромисс: Tail-based sampling (только медленные/ошибочные) или переход на Tempo

**4. Sensitive данные**
- Проблема: Трейсинг может логировать PII (email, телефоны)
- Компромисс: Не логируем query params, request body. Code review для всех spans

**5. Стоимость хранения**
- Проблема: Cassandra (3 ноды) ~$500-1000/месяц
- Компромисс: Retention 7 дней вместо 30, архивирование критичных в S3

**6. Влияние на производительность**
- Проблема: Каждый span +0.1-0.5 мс latency
- Компромисс: Не трассируем микро-операции, только значимые (HTTP, DB, business)

---

## 6. Аспекты безопасности

### 6.1 Доступ к Jaeger UI

**Аутентификация:**
- OAuth2/LDAP интеграция с корпоративным SSO
- Роли: "Support" (просмотр) и "DevOps" (администрирование)
- Отключение anonymous доступа

**Network-level:**
- Доступ только через VPN
- Security Group: только IP офиса + VPN subnet
- HTTPS с TLS 1.3

### 6.2 Защита данных

**Data sanitization:**
- Запрет логирования passwords, tokens, API keys, credit cards
- Whitelist подход для атрибутов
- Code review всех кастомных spans

**Шифрование:**
- Cassandra encryption at rest (TDE)
- Backup traces: шифрование перед S3

### 6.3 Защита Collector

**Network isolation:**
- Collector НЕ доступен из интернета
- Только internal VPC
- Firewall: только EC2 инстансы приложений

**Rate limiting:**
- Max 1000 spans/sec от источника
- Input validation: max 64KB на span

### 6.4 Compliance

**Retention:** 7 дней production, затем автоудаление или архивирование в encrypted S3

**Audit:** Логирование доступа к Jaeger UI, алерты при подозрительной активности

**GDPR:** Возможность удаления traces с PII по запросу

---

## 7. Дополнительное задание: Автоматический мониторинг на основе трейсинга

### 7.1 Мотивация

Jaeger UI хорош для ручного расследования, но нужен автоматический мониторинг аномалий. Решение: экспортировать метрики из traces в Prometheus → алертинг в Grafana.

### 7.2 Архитектура

**Компоненты (зеленым):**

**1. Jaeger SPM** — читает traces из Cassandra, агрегирует RED метрики, экспортирует в Prometheus

**2. Prometheus** — забирает метрики из Jaeger SPM `/metrics`

**3. Grafana Alerting** — алерты на основе span metrics, drill-down в Jaeger UI

**4. Alert Webhook Handler** — автоматизация действий (перезапуск, auto-scaling, создание tickets)

### 7.3 Примеры алертов

**1. Высокий error rate при расчете стоимости**
- Триггер: > 5% ошибок в течение 10 минут
- Действие: алерт в Slack с ссылкой на Jaeger traces

**2. Медленный расчет стоимости**
- Триггер: P95 latency > 30 минут
- Действие: алерт в PagerDuty

**3. Заказы застряли в RabbitMQ**
- Триггер: producer rate - consumer rate > 10 заказов/сек
- Действие: auto-scaling MES consumer workers

**4. Неполные traces (потеря сообщений)**
- Триггер: > 100 заказов не дошли от Shop до MES
- Действие: критичный алерт, проверка DLQ

### 7.4 Бизнес-метрики из traces

**Order Completion Rate:** % заказов от create_order до close_order (target: 99.5%)

**B2B API SLA:** % заказов обработанных за < 5 минут (target: 95%)

**Order Processing Time:** P95 время от SUBMITTED до MANUFACTURING_STARTED (SLA: 3 недели)

### 7.5 Автоматические действия

**Деградация MES API:** перезапуск инстанса, включение rate limiting, создание Jira ticket

**RabbitMQ переполнение:** auto-scaling consumer workers, алерт в PagerDuty

### 7.6 Обновленная диаграмма C4 (зеленым)

**Новые компоненты (автоматизация):**
- Jaeger SPM, Prometheus, Grafana, Alert Webhook Handler

**Новые связи (зеленым):**
- Jaeger SPM → Cassandra (чтение traces)
- Jaeger SPM → Prometheus (экспорт метрик)
- Prometheus → Grafana
- Grafana → Alert Webhook Handler
- Grafana ⟷ Jaeger Query (интеграция)

**Схема:** См. файл `Task3/Схема с трейсингом и автоматизацией.drawio` (компоненты автоматизации выделены зеленым, трейсинга — красным)

