# Архитектурное решение по логированию

## 1. Анализ системы и требуемые логи

### Системы для сбора логов:
- **Shop API** (Java Spring Boot)
- **CRM API** (Java Spring Boot)
- **MES API** (C#)
- **RabbitMQ** (брокер сообщений)

### Список логов с уровнем INFO:

#### Shop API:
1. Создание заказа: timestamp, customer_id, order_id, status=INITIATED
2. Загрузка файла: timestamp, customer_id, order_id, file_size, status=FILE_UPLOADED
3. Отправка заказа: timestamp, customer_id, order_id, status=SUBMITTED
4. Отправка сообщения в очередь: timestamp, order_id, queue_name, message_id
5. Получение сообщения из очереди: timestamp, order_id, queue_name, message_id

#### MES API:
1. Получение заказа на расчет: timestamp, order_id, polygon_count
2. Расчет стоимости: timestamp, order_id, calculation_time, price, status=PRICE_CALCULATED
3. Начало производства: timestamp, order_id, operator_id, status=MANUFACTURING_STARTED
4. Завершение производства: timestamp, order_id, operator_id, status=MANUFACTURING_COMPLETED
5. Упаковка: timestamp, order_id, operator_id, status=PACKAGING
6. Отправка: timestamp, order_id, status=SHIPPED
7. Отправка/получение сообщений очереди: timestamp, order_id, queue_name, message_id
8. API запросы от внешних пользователей: timestamp, api_user_id, order_id, endpoint, response_time

#### CRM API:
1. Подтверждение заказа: timestamp, seller_id, order_id, status=MANUFACTURING_APPROVED
2. Закрытие заказа: timestamp, seller_id, order_id, status=CLOSED
3. Отправка/получение сообщений очереди: timestamp, order_id, queue_name, message_id

#### RabbitMQ:
1. Публикация сообщения: timestamp, queue_name, message_id, source_service
2. Доставка сообщения: timestamp, queue_name, message_id, target_service
3. Ошибки доставки: timestamp, queue_name, message_id, error_type

### Уровни логирования:

- **DEBUG**: детальная трассировка работы алгоритмов расчета стоимости в MES (при polygon_count > 10000)
- **INFO**: все события изменения статусов, бизнес-операции, интеграционные вызовы
- **WARN**: превышение времени расчета (>5 мин), высокая нагрузка на API (>1000 req/min), задержки в очереди (>30 сек)
- **ERROR**: ошибки обработки заказов, недоступность БД, сбои интеграции, потеря сообщений в очереди
- **FATAL**: критические сбои системы, требующие немедленного вмешательства

## 2. Мотивация

### Зачем нужно логирование:
1. **Отслеживание потерянных заказов** - логи покажут на каком этапе заказ "застрял" или потерялся
2. **Диагностика проблем** - сокращение времени разбора инцидентов с часов до минут
3. **Контроль SLA** - отслеживание времени обработки заказов по всей цепочке
4. **Расследование жалоб** - объективные данные вместо слов клиентов

### Технические метрики:
1. **MTTR (Mean Time To Resolution)**: снижение с 4-6 часов до 15-30 минут
2. **Количество повторных обращений**: сокращение на 60% за счет проактивного выявления проблем
3. **Процент успешно обработанных заказов**: увеличение с текущих ~85% до 98%

### Бизнес-метрики:
1. **Удержание клиентов**: снижение оттока B2B клиентов на 40%
2. **Стоимость поддержки**: сокращение времени на один инцидент на 70%
3. **Возврат крупных контрактов**: восстановление 2-3 потерянных контрактов за квартал

## 3. Приоритизация систем

### Первая очередь:
1. **MES API** - критично, т.к. здесь расчет стоимости и основные жалобы на потерянные заказы
2. **RabbitMQ** - ключевая точка интеграции, потеря сообщений = потеря заказов
3. **Shop API** - входная точка B2C заказов

### Вторая очередь:
4. **CRM API** - меньше критичности, но важен для полной картины

**Обоснование**: Жалобы на потерянные заказы и проблемы с API пользователями указывают на MES и интеграцию через RabbitMQ как на основные проблемные зоны.

## 4. Предлагаемое решение

### Технологический стек:

**ELK Stack (Elasticsearch + Logstash + Kibana)**:
- **Filebeat** - агенты сбора логов на каждом сервере
- **Logstash** - централизованная обработка и обогащение логов
- **Elasticsearch** - хранение и индексация
- **Kibana** - визуализация и дашборды

### Компоненты для внедрения:

1. **Filebeat** на каждом EC2 инстансе (Shop API, CRM API, MES API)
2. **Logstash** кластер (2 ноды для отказоустойчивости)
3. **Elasticsearch** кластер (3 ноды: master + 2 data nodes)
4. **Kibana** для визуализации

### Формат логов (JSON):
```json
{
  "timestamp": "2025-10-26T10:15:30.123Z",
  "service": "mes-api",
  "level": "INFO",
  "trace_id": "abc123...",
  "span_id": "def456...",
  "order_id": "12345",
  "user_id": "hashed_value",
  "event": "order_status_changed",
  "details": {
    "old_status": "SUBMITTED",
    "new_status": "PRICE_CALCULATED",
    "duration_ms": 180000
  }
}
```

**trace_id и span_id** - для корреляции с трейсами Jaeger, обеспечивает сквозную видимость: от метрик Prometheus → к логам ELK → к трейсам Jaeger.

### Интеграция:
- Java приложения: **Logback** с **logstash-logback-encoder**
- C# приложение: **Serilog** с **Serilog.Sinks.Elasticsearch**
- RabbitMQ: стандартные логи + custom плагин для structured logging

### Схема архитектуры:
```
                                    ┌─→ [Prometheus] ────┐
[Shop API] ──→ [Filebeat] ──┐      │  (метрики)         │
[CRM API]  ──→ [Filebeat] ──┼──→ [Logstash] ──→ [Elasticsearch] ──┐
[MES API]  ──→ [Filebeat] ──┤      │  (логи)            │         │
[RabbitMQ] ──→ [Filebeat] ──┘      │                    │         │
                                    └─→ [Jaeger] ────────┘         │
                                       (трейсинг)                  │
                                                                   ↓
                                    [Grafana] ←────────────── [Kibana]
                                 (единая точка               (детальный 
                                  визуализации)              поиск логов)
                                        │
                                        ↓
                                  [Alertmanager]
```

**Интеграция с системами мониторинга:**
- Elasticsearch добавляется как data source в Grafana
- Алертинг через Alertmanager (единая система для всех компонентов)
- trace_id связывает Prometheus метрики → ELK логи → Jaeger трейсы
- Grafana - единая точка входа для всех систем observability

## 5. Политика безопасности

### Чувствительные данные:
1. **Хеширование**: customer_id, seller_id, operator_id хешируются SHA-256
2. **Маскирование**: email заменяется на `u***@domain.com`
3. **Исключение**: данные платежей, персональные данные не логируются

### Доступ к логам:
- **Полный доступ**: DevOps-инженер, архитектор, тимлид
- **Чтение своего сервиса**: разработчики Java/C# (только их микросервисы)
- **Только дашборды**: продакт-менеджер, менеджеры продаж
- **Запрещен**: операторы, продавцы

### Безопасность:
- **Аутентификация**: OAuth2/LDAP интеграция с корпоративным SSO
- **Network-level**: доступ к Kibana только через VPN, Security Group ограничивает доступ
- **Шифрование**: логи передаются по TLS 1.3, Elasticsearch encryption at rest
- **Изоляция**: Elasticsearch кластер в приватной подсети VPC

## 6. Политика хранения

### Индексы:
- **shop-api-logs-YYYY.MM.DD** - отдельный индекс на день
- **crm-api-logs-YYYY.MM.DD**
- **mes-api-logs-YYYY.MM.DD**
- **rabbitmq-logs-YYYY.MM.DD**

### Сроки хранения:
- **Hot storage** (SSD): последние 7 дней - быстрый поиск, активное расследование
- **Warm storage** (HDD): 8-30 дней - редкий доступ, исторический анализ
- **Cold storage** (S3): 31-90 дней - архив для compliance, редкие расследования
- **Удаление**: после 90 дней (или дольше для соблюдения законодательства)

### Размеры (прогноз):
- Текущая нагрузка: ~3000 заказов/месяц
- Логов на заказ: ~50 записей (все этапы)
- Размер записи: ~1KB
- **Итого**: ~150MB/месяц на текущую нагрузку
- С ростом на 100 заказов/месяц: +5MB/месяц
- **Запас**: кластер 500GB (3+ года роста)

## 7. Система анализа логов

### Алертинг:

**Интеграция с Alertmanager:** Логи из Elasticsearch агрегируются в метрики через Logstash metrics filter → отправляются в Prometheus → алертинг через Alertmanager (единая система для всех компонентов).

**Критические алерты** (PagerDuty + Slack):
1. Заказ в статусе SUBMITTED >2 часа без перехода в PRICE_CALCULATED
2. Сообщение в очереди >5 минут без обработки
3. Error rate >5% за 5 минут (из логов ERROR level)
4. API response time >30 сек (из application logs)

**Предупреждения** (Slack):
1. Расчет стоимости >10 минут
2. Нагрузка API >1500 req/min
3. Количество заказов в очереди >100

### Поиск аномалий:

**ML-based anomaly detection** (Kibana ML):
1. **Аномальный рост заказов**: 4 → 10000 за секунду (возможно DDoS)
2. **Аномальное время расчета**: обычно 2 мин, стало 25 мин
3. **Spike в ошибках**: обычно 2-3/час, стало 50/мин

**Правила корреляции**:
- Если SUBMITTED записан, но нет сообщения в очередь → алерт "Потерянная интеграция"
- Если message_published есть, но message_delivered нет через 1 мин → алерт "Потеря сообщения"

### Дашборды:

**Grafana** (основная точка визуализации):
1. **Unified Observability Dashboard**: метрики (Prometheus) + логи (Elasticsearch) + трейсы (Jaeger)
2. **Error Analytics**: корреляция ERROR логов с метриками и трейсами
3. **SLA Dashboard**: бизнес-метрики с drill-down в логи

**Kibana** (детальный анализ логов):
1. **Order Tracking**: полнотекстовый поиск заказа по order_id
2. **Log Explorer**: фильтрация по service, level, time range
3. **Error Investigation**: детальный просмотр stack traces

## 8. Критерии выбора технологии (дополнительно)

| Критерий | ELK Stack | OpenSearch | Splunk | Loki (Grafana) |
|----------|-----------|------------|--------|----------------|
| **Лицензия** | Elastic License (ограничения на коммерческое использование) | Apache 2.0 (полностью открыта) | Проприетарная | Apache 2.0 |
| **Стоимость** | Бесплатно (Basic), платные фичи от $95/месяц | Бесплатно | $150+/GB/год | Бесплатно |
| **Масштабируемость** | До 100TB+ | До 100TB+ | Отлично, но дорого | До 10TB (оптимально) |
| **Экосистема** | Богатая (Beats, APM, SIEM) | Совместима с ELK | Огромная, enterprise | Интеграция с Prometheus, Grafana |
| **Сложность внедрения** | Средняя (2-3 недели) | Средняя (2-3 недели) | Простая, но дорогая | Низкая (1 неделя) |
| **Поддержка структурированных логов** | Отлично | Отлично | Отлично | Хорошо (labels) |
| **ML/аномалии** | Да (платно) | В разработке | Да (встроено) | Нет |
| **Комьюнити** | Огромное | Растущее | Корпоративное | Растущее |

### Рекомендация: **ELK Stack (Elasticsearch + Logstash + Kibana)**

**Обоснование**:
- ✅ Богатая экосистема и зрелость продукта
- ✅ Отличная документация и большое комьюнити
- ✅ Готовые интеграции с Java/C#
- ✅ Мощные возможности поиска и визуализации
- ✅ Basic лицензия покрывает наши потребности
- ⚠️ Минус: некоторые ML-фичи платные (можно добавить позже)

**Альтернатива**: OpenSearch (если возникнут лицензионные ограничения ELK)

---

## 9. Итоговая архитектура Observability

### Единая система наблюдаемости:

```
┌─────────────────────────────────────────────────────────────────┐
│                    GRAFANA (Единая точка входа)                 │
│  - Метрики от Prometheus                                        │
│  - Логи от Elasticsearch                                        │
│  - Трейсы от Jaeger                                             │
│  - Drill-down между всеми источниками через trace_id           │
└────────────────────────┬────────────────────────────────────────┘
                         │
          ┌──────────────┼──────────────┐
          ↓              ↓              ↓
    [Prometheus]   [Elasticsearch]  [Jaeger]
    (метрики)         (логи)      (трейсинг)
          ↑              ↑              ↑
          └──────────────┼──────────────┘
                         │
        ┌────────────────┴────────────────┐
        ↓                                  ↓
   [Shop/CRM/MES API]              [RabbitMQ]
   (instrumented apps)          (message broker)
```

### Рабочий сценарий диагностики проблемы:

1. **Алерт в Slack** (Alertmanager): "MES API error rate >5%"
2. **Grafana Dashboard** → видим spike в ошибках на графике
3. **Drill-down в Elasticsearch** → находим конкретные ERROR логи с trace_id
4. **Переход в Jaeger** → видим полный путь запроса, находим узкое место
5. **Решение проблемы** за 15 минут вместо 4+ часов

### Выгоды для компании:
- **MTTR**: 4-8 часов → 15-30 минут (улучшение в 16 раз)
- **Возврат контрактов**: восстановление потерянных B2B клиентов
- **Проактивность**: обнаружение проблем до жалоб клиентов
- **Масштабируемость**: готовность к росту нагрузки +100 заказов/месяц

